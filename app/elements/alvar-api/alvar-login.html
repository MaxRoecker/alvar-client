<link rel="import" href="../../bower_components/polymer/polymer.html" />
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html" />
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html" />
<link rel="import" href="../../bower_components/iron-input/iron-input.html" />
<link rel="import" href="../../bower_components/iron-form/iron-form.html" />
<link rel="import" href="../../bower_components/paper-button/paper-button.html" />
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html" />
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html"
/>
<link rel="import" href="../../bower_components/paper-input/paper-input-container.html" />

<link rel="import" href="alvar-authentication.html">

<dom-module id="alvar-login">
  <template>
    <style>
      #login-dialog {
        --paper-dialog: {
          background-color: #fff;
          width: 65%;
          margin-left: -35%;
          margin-top: -25%;
          height: auto;
        }
        ;
      }

      #login-dialog-scrollable {
        height: 150px;
      }

    </style>

    <iron-ajax id="ajax" url="http://localhost:3000/api/Users/login" handle-as="json" content-type="application/json"
    method="POST" on-response="_handleLoginResponse" on-error="_handleErrorResponse"></iron-ajax>

    <iron-localstorage id="storage" name="alvar-authorization"></iron-localstorage>

    <paper-dialog id="login-dialog" modal>
      <h2>Login</h2>
      <paper-dialog-scrollable id="login-dialog-scrollable">
        <form is="iron-form" id="form" method="post" action="/">
          <paper-input-container>
            <label>Email</label>
            <input is="iron-input" id="form-email" type="email" name="email" required/>
            <paper-input-error>Informe um e-mail v√°lido</paper-input-error>
          </paper-input-container>
          <paper-input-container>
            <label>Senha</label>
            <input is="iron-input" id="form-password" type="password" name="password" required/>
            <paper-input-error>Informe a senha</paper-input-error>
          </paper-input-container>
        </form>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button on-click="_loginHandlerClick">Login</paper-button>
      </div>
    </paper-dialog>

  </template>
  <script>
    Polymer({
      is: 'alvar-login',

      open: function(){
        this.$['login-dialog'].open();
      },

      close: function(){
        this.$['login-dialog'].close();
      },

      login: function(user, email, password) {
        var credentials = {
          'username': user,
          'email': email,
          'password': password
        };
        this._requestLogin(credentials);
      },

      _loginHandlerClick: function () {
        var inputEmail = this.$['form-email'];
        var inputPassword = this.$['form-password'];
        var validation = inputEmail.validate() & inputPassword.validate();
        if(validation){
          this.login(null,inputEmail.value,inputPassword.value);
        }
      },

      _requestLogin: function(credentials) {
        var ajax = this.$['ajax'];
        ajax.body = credentials;
        ajax.generateRequest();
      },

      _handleLoginResponse: function() {
        var authorization = this.$['ajax'].lastResponse;
        this.$.storage.value = authorization;
        this.fire('authorized');
      },

      _handleErrorResponse: function() {
        console.error(this.$['ajax'].lastError);
      },

    });

  </script>
</dom-module>
