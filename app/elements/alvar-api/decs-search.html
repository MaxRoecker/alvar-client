<link rel="import" href="../../bower_components/polymer/polymer.html" />
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html" />
<link rel="import" href="../../bower_components/iron-input/iron-input.html" />
<link rel="import" href="../../bower_components/paper-input/paper-input-container.html" />
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html" />
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html" />
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html" />
<link rel="import" href="../../bower_components/paper-item/paper-item.html" />
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html" />
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html" />
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html" />

<dom-module id="decs-search">
  <template>
    <style>
      :host {
        display: block;
        --paper-item: {
          width: 100%;
        }
        ;
        --paper-menu: {
          width: calc(100% - 2rem);
        }
        ;
        --paper-menu-selected-item: {
          background-color: var(--light-primary-color);
        }
        ;
      }

      .row {
        display: flex;
        align-items: flex-end;
      }

      #input {
        flex-grow: 11;
      }

      .rotate {
        --paper-icon-button: {
          animation: spin 4s linear infinite;
        };
      }
      .no-rotate {
        --paper-icon-button: {
          animation: none;
        };
      }

      @keyframes spin {
        100% {
          transform: rotate(360deg);
        }
      }

      .tags{
        width: calc(100% - 2rem);
      }

      paper-spinner{
        margin: 1rem auto;
        display: block;
      }


    </style>

    <iron-ajax id="decs-ajax" method="get" url="http://0.0.0.0:3000/api/Resources/searchDecs" handle-as="json"
    on-response="_handleDecsResponse"></iron-ajax>
    <div>
      <template is="dom-repeat" items="[[selecteds]]">
        <paper-icon-item class="tags">
          <paper-icon-button icon="delete" index="[[index]]" item-icon on-click="removeSelected"></paper-icon-button>
          <paper-item-body two-line>
            <div>[[item.terms.pt]]</div>
            <div secondary>
              Sinônimos:
              <template is="dom-repeat" items="[[item.synonyms]]" as="synonym">
                <span>[[synonym]]</span>,
              </template>
            </div>
          </paper-item-body>
        </paper-icon-item>
      </template>
    </div>
    <div class="row">
      <div id="input">
        <paper-input-container always-float-label>
          <label>Pesquisar por descritores</label>
          <input is="iron-input" bind-value="{{search}}" />
        </paper-input-container>
      </div>
      <div>
        <paper-icon-button class="no-rotate" id="search-button" icon="search" on-click="_searchDecs"></paper-icon-button>
      </div>
    </div>
    <div>
      <paper-menu id="decs-result" attr-for-selected="name" on-selected-item-changed="_selectedChangedHandler">
        <template is="dom-repeat" items="[[results]]">
          <paper-icon-item name="[[item.terms.pt]]" index="[[index]]">
            <paper-icon-button icon="add" index="[[index]]" item-icon></paper-icon-button>
            <paper-item-body two-line>
              <div>[[item.terms.pt]]</div>
              <div secondary>
                Sinônimos:
                <template is="dom-repeat" items="[[item.synonyms]]" as="synonym">
                  <span>[[synonym]]</span>,
                </template>
              </div>
            </paper-item-body>
          </paper-icon-item>
        </template>
      </paper-menu>
      <paper-spinner id="spinner"></paper-spinner>
    </div>

  </template>
  <script>
    (function() {
      Polymer({
        is: 'decs-search',

        properties: {
          search: {
            type: String,
            reflectToAttribute: true,
          },
          results: {
            type: Array,
            notify: true,
            readOnly: true,
          },
          selecteds: {
            type: Array,
            notify: true,
            value: function() {
              return [];
            }
          }
        },

        _searchDecs: function() {
          var params = {
            'search': this.search
          };
          var decsAjax = this.$['decs-ajax'];
          decsAjax.params = params;
          decsAjax.generateRequest();

          var searchButton = this.$['spinner'];
          searchButton.active = true;
        },

        _handleDecsResponse: function() {
          var decsAjax = this.$['decs-ajax'];
          var results = decsAjax.lastResponse.result;
          this.$['decs-result'].selected = undefined;
          this._setResults(results);
          var searchButton = this.$['spinner'];
          searchButton.active = false;
        },

        _selectedChangedHandler: function() {
          var element = this.$['decs-result'].selectedItem;
          if (element) {
            var index = element.index;
            var tag = this.splice('results', index, 1)[0];

            var sameTermSelected = this.selecteds.filter(
              function(e) {
                return e.terms.pt === tag.terms.pt;
              }
            );

            if (sameTermSelected.length === 0) {
              this.push('selecteds', tag);
            }
          }
        },

        removeSelected: function(e) {
          this.splice('selecteds', e.path[1].index, 1);
        },

        serialize: function() {
          var tags = [];
          for (var i = 0; i < this.selecteds.length; i++) {
            var tag = this.selecteds[i];
            tags.push(this._tagFactory(tag.terms.pt, tag.synonyms));
          }
          return JSON.parse(JSON.stringify(tags));
        },

        reset: function(){
          this.search = null;
          this.selecteds = [];
          this._setResults([]);
        },

        _tagFactory: function(term, synonyms, mutable) {
          var tag = {
            'name': term || '',
            'synonyms': synonyms || [],
            'mutable': mutable || false,
          };
          return tag;
        },


      });
    })();

  </script>
</dom-module>
