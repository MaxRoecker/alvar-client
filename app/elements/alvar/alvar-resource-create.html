<dom-module id="alvar-resource-create">
  <link rel="import" href="../../bower_components/polymer/polymer.html" />
  <link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
  <link rel="import" href="../../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">
  <link rel="import" href="../../bower_components/iron-input/iron-input.html">
  <link rel="import" href="../../bower_components/iron-form/iron-form.html">

  <link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
  <link rel="import" href="../../bower_components/paper-material/paper-material.html">
  <link rel="import" href="../../bower_components/paper-input/paper-input-container.html">
  <link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
  <script src="../../bower_components/page/page.js"></script>

  <style>
    form.hidden {
      display: none;
    }

  </style>

  <template>
    <form is="iron-form" id="resource-create-form">
      <h2 class="paper-font-subhead">Informações</h2>
      <paper-input-container>
        <label>Nome</label>
        <input is="iron-input" name="name" />
      </paper-input-container>
      <paper-textarea label="Descrição" name="description" value=""></paper-textarea>
      <div class="form-actions">
        <paper-button raised class="paper-button--primary" onclick="saveResource()">
          Salvar
        </paper-button>
        <paper-button>
          Cancelar
        </paper-button>
      </div>
    </form>
    <form is="iron-form" id="resource-file-form" class="hidden">
      <h2 class="paper-font-subhead">Salvo! Selecione agora o arquivo:</h2>
      <paper-input-container>
        <label>Nome</label>
        <input type="file" is="iron-input" id="file-input" />
      </paper-input-container>
      <input id="resource-id" type="hidden" value="" />
      <div class="form-actions">
        <paper-button raised class="paper-button--primary" onclick="saveFile()">
          Salvar
        </paper-button>
      </div>
    </form>
  </template>

  <script>
    (function() {
      Polymer({
        is: 'alvar-resource-create',
        properties: {
          resource: Object
        },
        ready: function() {
          this.resource = null;
        }
      });
    })();

    var access_token = "COhr1U7NxFY7tXrXZ8IumOjop5twEW3VgkEt7U9Bww3v9AnoPg12onFXIlhrDWJJ";

    var saveFile = function() {
      var resourceId = document.querySelector('#resource-id').getAttribute('value');
      var archive = {};
      var file = document.querySelector('#file-input').files[0];
      archive['mimeType'] = file.type;
      archive['size'] = file.size;

      var reader = new FileReader();
      reader.onload = (
        function(obj) {
          return function(e) {
            var blob = e.target.result;
            obj['value'] = blob;

            console.log(blob.type);
            console.log(blob.size);
            console.log(obj);

            var request = new XMLHttpRequest();
            request.addEventListener(
              'load',
              function(){
                console.log(this.responseText);
                alert('Salvo!');
              }
            );
            request.open(
              'post',
              'http://0.0.0.0:3000/api/Resources/'+resourceId+'/archives?access_token='+access_token
            );
            request.setRequestHeader('Content-Type', 'application/json');
            request.send(JSON.stringify(obj));

          };
        }
      )(archive);
      reader.readAsDataURL(file);
    }

    var saveResourceSuccess = function() {
      resource = JSON.parse(this.responseText);
      console.log(resource);
      var form1 = document.querySelector('#resource-create-form');
      var form2 = document.querySelector('#resource-file-form');
      form1.classList.add('hidden');
      form2.classList.remove('hidden');
      var input = document.querySelector('#resource-id').setAttribute('value', resource.id);
    };

    var saveResource = function() {
      var form1 = document.querySelector('#resource-create-form');
      var resource = form1.serialize();
      var request = new XMLHttpRequest();
      request.addEventListener('load', saveResourceSuccess);
      request.open('post',
        'http://0.0.0.0:3000/api/Resources?access_token=' + access_token
      );
      request.setRequestHeader('Content-Type', 'application/json');
      request.send(JSON.stringify(resource));
    }

  </script>

</dom-module>
