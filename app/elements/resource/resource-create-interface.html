<dom-module is="resource-create-interface">
  <link rel="import" href="../../../bower_components/polymer/polymer.html" />
  <link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html" />
  <link rel="import" href="../../../bower_components/paper-header-panel/paper-header-panel.html" />
  <link rel="import" href="../../../bower_components/paper-material/paper-material.html" />
  <link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html" />
  <link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html" />
  <link rel="import" href="../../../bower_components/paper-spinner/paper-spinner.html" />
  <link rel="import" href="resource-form.html" />
  <link rel="import" href="../alvar-api/alvar-authentication.html" />

  <template>
    <style>
      paper-material {
        box-sizing: border-box;
        width: calc(100% - 2rem);
        margin: 1rem;
        padding: 1rem;
        background-color: #fff;
      }


    </style>
    <paper-header-panel>
      <paper-toolbar>
        <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
        <h1 class="paper-font-title flex-1">Adicionar recurso</h1>
        <paper-icon-button icon="done" on-click="createResource"></paper-icon-button>
        <paper-icon-button icon="more-vert" on-click="moreOptions"></paper-icon-button>
      </paper-toolbar>

      <div>
        <paper-material elevation="1">
          <resource-form id="resource-form"></resource-form>
          <div  style="text-align: center">
            <paper-spinner id="spinner" hidden></paper-spinner>
          </div>
        </paper-material>
      </div>



    </paper-header-panel>

    <iron-ajax id="ajax-resource" url="http://localhost:3000/api/Resources" method="POST" handle-as="json"
    content-type="application/json" on-response="_handleResourceResponse"></iron-ajax>
    <iron-ajax id="ajax-archive" url="" method="POST" handle-as="json" content-type="application/json" on-response="_handleArchiveResponse"></iron-ajax>
    <iron-ajax id="ajax-tag" url="" method="POST" handle-as="json" content-type="application/json" on-response="_handleTagsResponse"></iron-ajax>
    <alvar-authentication id="authentication"></alvar-authentication>
  </template>
  <script>
    (function() {
      Polymer({
        is: 'resource-create-interface',

        properties: {
          resource: Object,
        },

        /**
         * Creates a resource.
         *
         */
        createResource: function() {
          var authorization = this.$['authentication'].authorize();
          if (authorization) {
            //TODO Validate the form
            var resourceForm = this.$['resource-form'];
            var resource = resourceForm.serializeResource();
            var ajax = this.$['ajax-resource'];
            ajax.headers = {
              'Authorization': authorization.id
            }
            ajax.body = resource;
            ajax.generateRequest();

            this.toggleAttribute('hidden',true,resourceForm);
            var spinner = this.$['spinner'];
            this.toggleAttribute('hidden',false,spinner);
            this.toggleAttribute('active',true,spinner);

          }
          else {
            this.fire('unauthorized');
          }
        },

        /**
         * Handler of response of Resource to Alvar API.
         */
        _handleResourceResponse: function() {
          var authorization = this.$['authentication'].authorization;
          var ajaxResource = this.$['ajax-resource'];
          var resource = ajaxResource.lastResponse;
          this.resource = resource;
          console.log('Recurso salvo!', resource);

          var ajaxArchive = this.$['ajax-archive'];
          ajaxArchive.headers = {
            'Authorization': authorization
          };

          var archive = this.$['resource-form'].serializeArchive();
          ajaxArchive.url = 'http://localhost:3000/api/Resources/' + resource.id +
            '/archive';
          ajaxArchive.body = archive;
          ajaxArchive.generateRequest();
        },

        _handleArchiveResponse: function() {
          var ajaxArchive = this.$['ajax-archive'];
          var archive = ajaxArchive.lastResponse;
          console.log('Archive salvo!', archive);

          var authorization = this.$['authentication'].authorization;
          var ajaxTag = this.$['ajax-tag'];
          ajaxTag.headers = {
            'Authorization': authorization
          };

          var tags = this.$['resource-form'].serializeTags();
          console.log(tags);
          ajaxTag.url = 'http://localhost:3000/api/Resources/' + this.resource.id + '/tags';
          ajaxTag.body = tags;
          ajaxTag.generateRequest();
        },

        _handleTagsResponse: function() {
          var ajaxTag = this.$['ajax-tag'];
          var tags = ajaxTag.lastResponse;
          console.log('Tags salvas', tags);
          this.fire('resource-created',this.resource);

          var spinner = this.$['spinner'];
          this.toggleAttribute('hidden',true,spinner);
          this.toggleAttribute('active',false,spinner);

          var resourceForm = this.$['resource-form'];
          resourceForm.reset();
          this.toggleAttribute('hidden',false,resourceForm);


        },

        moreOptions: function() {
          console.log('Not implemented yet.');
        },

      });
    })();

  </script>
</dom-module>
