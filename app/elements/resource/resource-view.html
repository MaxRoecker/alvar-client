<dom-module is="resource-view">
  <link rel="import" href="../../../bower_components/polymer/polymer.html" />
  <link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html" />
  <link rel="import" href="../../../bower_components/paper-styles/paper-styles-classes.html">
  <link rel="import" href="../../../bower_components/paper-header-panel/paper-header-panel.html" />
  <link rel="import" href="../../../bower_components/paper-material/paper-material.html" />
  <link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html" />
  <link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html" />
  <link rel="import" href="../../../bower_components/paper-spinner/paper-spinner.html" />

  <template>
    <style>
      paper-material {
        box-sizing: border-box;
        width: calc(100% - 2rem);
        margin: 1rem;
        padding: 1rem;
        background-color: #fff;
      }

      .label {
        color: var(--secondary-text-color);
      }

      paper-spinner {
        display: block;
        margin: 5rem auto;
      }

    </style>
    <paper-header-panel>
      <paper-toolbar>
        <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
        <h1 class="paper-font-title flex-1">
          <span>Visualizar Recurso</span>
        </h1>
        <paper-icon-button icon="file-download" on-click="download"></paper-icon-button>
        <paper-icon-button icon="star-border"></paper-icon-button>
      </paper-toolbar>

      <div>
        <paper-spinner id="spinner"></paper-spinner>
        <paper-material id="material" elevation="1" hidden>
          <p class="paper-font-body2">
            <span class="paper-font-body1 label">Nome</span>
            <br/>
            <span>[[resource.name]]</span>
          </p>
          <p class="paper-font-body2">
            <span class="paper-font-body1 label">Descrição</span>
            <br/>
            <span>[[resource.description]]</span>
          </p>
          <p class="paper-font-body2">
            <span class="paper-font-body1 label">Descritores</span>
            <br/>
            <template is="dom-repeat" items="[[resource.tags]]">
              <span>[[item.name]]</span>
            </template>
          </p>
        </paper-material>
      </div>
    </paper-header-panel>

    <iron-ajax id="ajax-resource" method="GET" handle-as="json" content-type="application/json" on-response="_handleResourceResponse"
    on-error="_handleResourceError"></iron-ajax>

  </template>

  <script src="../../scripts/download.js"></script>
  <script>
    (function() {
      Polymer({
        is: 'resource-view',

        properties: {
          resourceId: {
            type: Number,
            observer: '_resourceIdObserver'
          },
          resource: {
            type: Object,
            notify: true,
            value: null,
          }
        },

        ready: function() {

        },

        _resourceIdObserver: function(newValue, oldValue) {

          var spinner = this.$['spinner'];
          this.toggleAttribute('hidden', false, spinner);
          spinner.active = true;
          var material = this.$['material'];
          this.toggleAttribute('hidden', true, material);

          var ajaxResource = this.$['ajax-resource'];
          ajaxResource.url = 'http://localhost:3000/api/Resources/' + this.resourceId;
          ajaxResource.params = {
            'filter': JSON.stringify({
              "include": ["tags", "archive"]
            })
          };
          ajaxResource.generateRequest();
        },

        _handleResourceResponse: function() {
          var ajaxResource = this.$['ajax-resource'];
          this.resource = ajaxResource.lastResponse;
          var spinner = this.$['spinner'];
          spinner.active = false;
          this.toggleAttribute('hidden', true, spinner);
          var material = this.$['material'];
          this.toggleAttribute('hidden', false, material);
        },

        _handleResourceError: function() {
          //TODO Check error
        },

        download: function() {
          var b64Data = this.resource.archive.payload.split(',')[1];
          var blob = this._b64toBlob(b64Data,this.resource.archive.type);
          //var blobUrl = URL.createObjectURL(blob);
          download(blob,this.resource.name,this.resource.archive.type)
        },

        _b64toBlob : function(b64Data, contentType, sliceSize) {
          contentType = contentType || '';
          sliceSize = sliceSize || 512;
          var byteCharacters = atob(b64Data);
          var byteArrays = [];

          for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
            var slice = byteCharacters.slice(offset, offset + sliceSize);
            var byteNumbers = new Array(slice.length);
            for (var i = 0; i < slice.length; i++) {
              byteNumbers[i] = slice.charCodeAt(i);
            }
            var byteArray = new Uint8Array(byteNumbers);
            byteArrays.push(byteArray);
          }
          var blob = new Blob(byteArrays, {
            type: contentType
          });
          return blob;
        },



      });
    })();

  </script>
</dom-module>
